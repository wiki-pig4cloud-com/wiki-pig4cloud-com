---
title: "Token ç”Ÿæˆè®¤è¯è¯¦è§£ğŸ‘"
---

![è®¤è¯æµç¨‹](/images/1655009689863-67ed08c2-cf22-449a-9d75-fc6831c17e8c.png)

```powershell
POST /auth/oauth2/token?grant_type=password&scope=server HTTP/1.1
Host: pig-gateway:9999
Authorization: Basic dGVzdDp0ZXN0
Content-Type: application/x-www-form-urlencoded
Content-Length: 32
username=admin&password=YehdBPev
```

## ç½‘å…³å‰ç½®å¤„ç†

ç½‘å…³ä¸­æœ€é‡è¦çš„åŠŸèƒ½æ˜¯**è·¯ç”±è½¬å‘**ï¼Œæ ¹æ®è¯·æ±‚å‰ç¼€åŒ¹é…åˆ°å¯¹åº”æœåŠ¡ã€‚æ¯”å¦‚æ‰€æœ‰ä»¥ **/auth** å¼€å¤´çš„è¯·æ±‚ä¼šè‡ªåŠ¨è½¬å‘è‡³ pig-auth æœåŠ¡çš„æ¥å£å¤„ç†ã€‚

```yaml
spring:
  cloud:
    gateway:
      routes:
        # è®¤è¯ä¸­å¿ƒ
        - id: pig-auth
          uri: lb://pig-auth
          predicates:
            - Path=/auth/**
        #UPMS æ¨¡å—
         ...
```

<Warning>
åœ¨ **PigRequestGlobalFilter** è¿‡æ»¤å™¨ä¸­å¦å¤–ä¸€ä¸ªé‡è¦çš„åŠŸèƒ½å°±æ˜¯æˆªå–è·¯ç”±å‰ç¼€
</Warning>

ä¾‹å¦‚ï¼š[http://127.0.0.1:9999/auth/oauth2/token](http://127.0.0.1:9999/auth/oauth2/token) è½¬å‘åˆ° pig-auth çš„è¯·æ±‚è·¯å¾„è‡ªåŠ¨æˆªå– å‰ç¼€å˜æˆ[http://127.0.0.1:3000/oauth2/token](http://127.0.0.1:3000/oauth2/token)

## éªŒè¯ç æ ¡éªŒå¤„ç†

pig-auth è®¤è¯ä¸­å¿ƒåœ¨æ¥æ”¶åˆ°ç½‘å…³è½¬å‘çš„è¯·æ±‚åï¼Œä¼šé€šè¿‡ ValidateCodeFilter å¯¹éªŒè¯ç ï¼ˆå›¾å½¢ã€çŸ­ä¿¡ï¼‰ç­‰è¿›è¡Œæ ¡éªŒ

![éªŒè¯ç æ ¡éªŒ](https://minio.pigx.top/oss/202407/1721222163.png)

## å‰ç«¯è¯·æ±‚å¯†æ–‡è§£å¯†

pig-auth åœ¨å¤„ç†å®ŒéªŒè¯ç åˆ¤æ–­é€»è¾‘åï¼ŒPasswordDecoderFilter é’ˆå¯¹ `/oauth2/token` è¯·æ±‚ä¼šè¿›è¡Œå‰ç«¯å¯†ç è§£å¯†ã€‚

```bash
passwordå¯†æ–‡ï¼šJFat0Zdc

è½¬æˆ

passwordæ˜æ–‡ï¼š123456
```

## å®¢æˆ·ç«¯è®¤è¯å¤„ç†

![å®¢æˆ·ç«¯è®¤è¯](/images/1655008151609-259b5111-2af6-4652-9667-de8c3271c67e.png)

å¦‚ä¸Šå›¾åœ¨ç™»å½•è¯·æ±‚ä¸­ä¼šæºå¸¦ Basic base64(clientId:clientSecret)ï¼Œé‚£ä¹ˆé¦–å…ˆ**OAuth2ClientAuthenticationFilter ä¼šé€šè¿‡è°ƒç”¨ RegisteredClientRepository (æ•°æ®åº“å­˜å‚¨) æ¥åˆ¤æ–­ä¼ å…¥çš„å®¢æˆ·ç«¯æ˜¯å¦æ­£ç¡®**

![å®¢æˆ·ç«¯è®¤è¯æµç¨‹](/images/1655008257496-fc950ccb-525d-42d6-bebf-575202042472.png)

## æ­£å¼æ¥æ”¶ç™»å½•è¯·æ±‚

<Warning>
**OAuth2TokenEndpointFilter** ä¼šæ¥æ”¶é€šè¿‡ä¸Šæ–‡ **OAuth2ClientAuthenticationFilter å®¢æˆ·ç«¯è®¤è¯çš„è¯·æ±‚**
</Warning>

![ç™»å½•è¯·æ±‚å¤„ç†](/images/1655008604032-0907b2ab-6cd8-4c51-9794-9176a105f0f7.png)

## ç»„è£…è®¤è¯å¯¹è±¡

<Warning>
**AuthenticationConverter** ä¼šæ ¹æ®è¯·æ±‚ä¸­çš„å‚æ•°å’Œæˆæƒç±»å‹ç»„è£…æˆå¯¹åº”çš„æˆæƒè®¤è¯å¯¹è±¡
</Warning>

![è®¤è¯å¯¹è±¡ç»„è£…](/images/1655009149085-435ed4ec-fa3a-405c-afcf-aa8389a70673.png)

## ç™»å½•è®¤è¯å¯¹è±¡

```powershell
public class XXXAuthenticationToken extends OAuth2ResourceOwnerBaseAuthenticationToken {

}
```

![è®¤è¯å¯¹è±¡](/images/1655009498004-55ff0b5b-ccd4-4df8-afd0-971844375546.png)

## æˆæƒè®¤è¯è°ƒç”¨

![æˆæƒè®¤è¯](/images/1655010008256-24f23104-de2a-4f0a-a275-f3d043456f6f.png)

## æ ¸å¿ƒè®¤è¯é€»è¾‘

![æ ¸å¿ƒè®¤è¯](/images/1655010229277-15676ade-f60d-4344-884d-4038b1e469dc.png)

### å¤šç”¨æˆ·ä½“ç³»åŒ¹é… UserDetailsService

![ç”¨æˆ·ä½“ç³»åŒ¹é…](/images/1655010271235-ab36132e-9809-4c54-b345-9d3eeb3522e6.png)

### å¯†ç åŒ¹é…æ ¡éªŒ

![å¯†ç æ ¡éªŒ](/images/1655010332384-c12b9906-c1c4-4bb4-9884-23681eeed841.png)

### ç”¨æˆ·çŠ¶æ€æ ¡éªŒ

![çŠ¶æ€æ ¡éªŒ](https://minio.pigx.vip/oss/1655010392.png)

## ç”¨æˆ·æŸ¥è¯¢é€»è¾‘

<Warning>
**ç”¨æˆ·æŸ¥è¯¢é€»è¾‘çš„å¤šç§å®ç°å½¢å¼**

- **è§£è€¦ï¼šé€šè¿‡ feign æŸ¥è¯¢å…¶ä»–ç³»ç»Ÿè·å–å¹¶ç»„è£…æˆ **UserDetails
- ç®€å•ï¼šè®¤è¯ä¸­å¿ƒç›´æ¥æŸ¥è¯¢ DB **å¹¶ç»„è£…æˆ **UserDetails
</Warning>

![ç”¨æˆ·æŸ¥è¯¢](/images/1655010519353-b93f1831-22f0-4c9e-80cb-75c514c87949.png)

## å¯†ç æ ¡éªŒé€»è¾‘

![å¯†ç æ ¡éªŒ](/images/1655010719145-1bdf7f3d-e099-48eb-9efa-dcca983b4d1b.png)

![å¯†ç æ ¡éªŒæµç¨‹](/images/1655010844595-0631d528-a839-4018-95c2-9d45aa0ad6d1.png)

<Warning>
é»˜è®¤æ”¯æŒåŠ å¯†æ–¹å¼å¦‚ä¸‹ï¼š  

**{noop}å¯†ç æ˜æ–‡**

**{åŠ å¯†ç‰¹å¾ç }å¯†ç å¯†æ–‡**

PasswordEncoder ä¼šè‡ªåŠ¨æ ¹æ®ç‰¹å¾ç åŒ¹é…å¯¹åº”çš„åŠ å¯†ç®—æ³•ï¼Œæ‰€ä»¥ä¸Šä¸€æ­¥â‘§ æŸ¥è¯¢ç”¨æˆ·å¯¹è±¡ç»„è£…æˆ UserDetails éœ€è¦ç‰¹æ®Šå¤„ç†
</Warning>

```java
return new UserDetails(user.getUsername(),"{bcrypt}"+"æ•°æ®åº“å­˜å‚¨çš„å¯†æ–‡");
```

## ç”Ÿæˆ OAuth2AccessToken

![1746005912](https://minio.pigx.vip/oss/202504/1746005912)

## Token å­˜å‚¨æŒä¹…åŒ–

![1746005920](https://minio.pigx.vip/oss/202504/1746005920)

<Warning>
å½“å‰ SAS ä»…æ”¯æŒ JDBC å’Œå†…å­˜ï¼ŒPIG æ‰©å±•æ”¯æŒ Redis å®ç°
</Warning>

![1746005933](https://minio.pigx.vip/oss/202504/1746005933)

## ç™»å½•æˆåŠŸäº‹ä»¶å¤„ç†

<Warning>
åŸºäº SpringEvent äº‹ä»¶å¤„ç†ï¼Œå¯ä»¥åœ¨è¿™é‡Œåšæ›´å¤šçš„å¤„ç† æ—¥å¿—ã€ä¸ªæ€§åŒ–ç­‰å¤„ç†é€»è¾‘
</Warning>

![äº‹ä»¶å¤„ç†](/images/1655011452193-a994951e-e12a-43a4-aa18-295038ae04fc.png)

## è¯·æ±‚ç»“æœè¾“å‡º Token

```java
private void sendAccessTokenResponse(HttpServletRequest request, HttpServletResponse response,
        Authentication authentication) throws IOException {

    OAuth2AccessTokenAuthenticationToken accessTokenAuthentication = (OAuth2AccessTokenAuthenticationToken) authentication;

    OAuth2AccessToken accessToken = accessTokenAuthentication.getAccessToken();
    OAuth2RefreshToken refreshToken = accessTokenAuthentication.getRefreshToken();
    Map<String, Object> additionalParameters = accessTokenAuthentication.getAdditionalParameters();
    // æ— çŠ¶æ€ æ³¨æ„åˆ é™¤ context ä¸Šä¸‹æ–‡çš„ä¿¡æ¯
    SecurityContextHolder.clearContext();
    this.accessTokenHttpResponseConverter.write(accessTokenResponse, null, httpResponse);
}
```

<Warning>
**å®šä¹‰å…·ä½“çš„è¾“å‡ºè¿”å›æ ¼å¼ç­‰é€»è¾‘**
</Warning>

![1746005821](https://minio.pigx.vip/oss/202504/1746005821)

## â™¥ï¸ è·å–æ”¯æŒ
<Card title="é‡åˆ°é—®é¢˜ï¼Ÿ" horizontal icon="link" href="https://gitee.com/log4j/pig/issues">
  å¦‚æœæ‚¨åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­é‡åˆ°ä»»ä½•é—®é¢˜ã€æœ‰åŠŸèƒ½å»ºè®®æˆ–éœ€æ±‚ï¼Œè¯·ç‚¹å‡»æ­¤å¡ç‰‡å‰å¾€ Gitee ä»“åº“æäº¤ Issueã€‚
</Card>

