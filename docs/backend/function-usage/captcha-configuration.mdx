---
title: "验证码配置"
---

## 功能说明

<Note>
验证码功能用于防止恶意请求和机器人攻击，提供基本的访问控制。
</Note>

## 配置步骤

### 1. 引入依赖

在 `pig-upms-biz` 模块中引入验证码依赖：

```xml
<dependency>
    <groupId>com.pig4cloud.plugin</groupId>
    <artifactId>anti-reptile-spring-boot-starter</artifactId>
    <version>0.0.3</version>
</dependency>
```

### 2. 配置参数

在 Nacos 配置文件中添加以下配置：

```yaml
anti:
  reptile:
    enabled: true
    global-filter-mode: true # 开启全局反爬，也可通过注解或配置文件指定需要反爬的接口
    ip-rule:
      request-max-size: 2
spring:
  redisson:
    address: redis://127.0.0.1:6379
```

### 3. 前端配置

在 `pig-ui` 的 `src/router/axios` 的 HTTP response 拦截器中添加异常拦截配置：

```javascript
// HTTP response 拦截
axios.interceptors.response.use(
  res => {
    NProgress.done();
    const status = Number(res.status) || 200;
    const message = res.data.msg || errorCode[status] || errorCode.default;
    
    if (status === 424) {
      MessageBox.confirm("令牌状态已过期，请点击重新登录", "系统提示", {
        confirmButtonText: "重新登录",
        cancelButtonText: "取消",
        type: "warning"
      })
        .then(() => {
          store.dispatch("LogOut").then(() => {
            window.location.reload();
          });
        })
        .catch(() => {});
      return;
    }
    
    if (status !== 200 || res.data.code === 1) {
      Message({
        message: message,
        type: "error"
      });
      return Promise.reject(new Error(message));
    }
    
    return res;
  },
  error => {
    if (error.response.status === 509) {
      const html = error.response.data;
      const verifyWindow = window.open("", "_blank", "height=400,width=560");
      verifyWindow.document.write(html);
      verifyWindow.document.getElementById("baseUrl").value = "http://localhost:8080/admin";
    }
    NProgress.done();
    return Promise.reject(new Error(error));
  }
);
```

### 4. 权限配置

在 Nacos 的 `application-dev.yml` 中添加以下配置以放开验证码相关接口权限：

```yaml
security:
  ignore:
    urls: /kk-anti-reptile/**
```

## 配置参数说明

<Tabs>
  <Tab title="基础配置">
    | 参数名 | 描述 | 默认值 | 示例 |
    | --- | --- | --- | --- |
    | enabled | 是否启用反爬虫插件 | true | true |
    | globalFilterMode | 是否启用全局拦截模式 | false | true |
    | include-urls | 局部拦截时，需要反爬的接口列表，以逗号分隔，支持正则匹配 | 空 | /client,/user,^/admin/.*$ |
  </Tab>
  <Tab title="IP规则">
    | 参数名 | 描述 | 默认值 | 示例 |
    | --- | --- | --- | --- |
    | ip-rule.enabled | 是否启用 IP Rule | true | true |
    | ip-rule.expiration-time | 时间窗口长度 (ms) | 5000 | 5000 |
    | ip-rule.request-max-size | 单个时间窗口内，最大请求数 | 20 | 20 |
    | ip-rule.lock-expire | 命中规则后自动解除时间（单位：秒） | 864000 | 20 |
    | ip-rule.ignore-ip | IP 白名单，支持后缀星号通配，以逗号分隔 | 空 | 192.168.*,127.0.0.1 |
  </Tab>
  <Tab title="UA规则">
    | 参数名 | 描述 | 默认值 | 示例 |
    | --- | --- | --- | --- |
    | ua-rule.enabled | 是否启用 User-Agent Rule | true | true |
    | ua-rule.allowed-linux | 是否允许 Linux 系统访问 | false | false |
    | ua-rule.allowed-mobile | 是否允许移动端设备访问 | true | true |
    | ua-rule.allowed-pc | 是否允许 PC 设备访问 | true | true |
    | ua-rule.allowed-iot | 是否允许物联网设备访问 | false | false |
    | ua-rule.allowed-proxy | 是否允许代理访问 | false | false |
  </Tab>
</Tabs>

## 常见问题

<Card title="验证码不显示" icon="warning" href="/docs/faq/login-issues/captcha-not-showing">
  如果验证码不显示，请检查 Redis 服务是否正常运行，以及相关配置是否正确。
</Card>

## 问题咨询

如有问题，请通过官方渠道咨询。 